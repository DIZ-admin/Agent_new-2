# Руководство по интеграционному тестированию в Docker

Эта документация описывает процедуру проведения интеграционного тестирования проекта Photo Agent в Docker-контейнере перед развертыванием в production-среде.

## Обзор системы тестирования

Интеграционное тестирование включает в себя два основных компонента:

1. **Модульные тесты (test_integration.py)** - тестируют взаимодействие между компонентами приложения с использованием моков.
2. **Docker-тесты (test_docker.py)** - проверяют правильность работы всего приложения внутри Docker-контейнера.

## Необходимые компоненты

- Python 3.8 или выше
- Docker и Docker Compose
- Модули python: unittest, pytest, pytest-mock

## Подготовка к тестированию

1. Убедитесь, что Docker установлен и запущен:
   ```bash
   docker --version
   docker-compose --version
   ```

2. Создайте виртуальное окружение для запуска тестов (это автоматически делают скрипты run_tests):
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate.bat  # Windows
   pip install -r requirements.txt
   pip install pytest pytest-mock
   ```

## Запуск тестов

Для запуска всех тестов используйте следующие команды:

### Linux/Mac:
```bash
./tests/run_tests.sh
```

### Windows:
```cmd
tests\run_tests.bat
```

Для запуска только определённого типа тестов добавьте аргумент:

- Только модульные тесты: `./tests/run_tests.sh unit`
- Только Docker-тесты: `./tests/run_tests.sh docker`

## Структура тестов

### Модульные тесты (test_integration.py)

Эти тесты проверяют взаимодействие между компонентами системы, используя mock-объекты для имитации внешних сервисов (SharePoint, OpenAI). Они тестируют следующие функции:

1. Извлечение схемы метаданных из SharePoint
2. Скачивание и обработку фотографий
3. Анализ фотографий с помощью OpenAI
4. Генерацию метаданных для загрузки
5. Загрузку фотографий в SharePoint
6. Полный процесс обработки

### Docker-тесты (test_docker.py)

Эти тесты проверяют работу приложения внутри Docker-контейнера. Они выполняют следующие действия:

1. Создание тестовой среды с конфигурацией и данными
2. Сборка Docker-образа
3. Проверка окружения контейнера
4. Выполнение каждого модуля приложения с моками для внешних сервисов
5. Проверка результатов выполнения

## Анализ результатов

После выполнения тестов вы увидите сводку результатов. В случае ошибки, детали будут выведены в консоль.

## Интеграция с CI/CD

Эти тесты можно интегрировать с CI/CD-системой (например, GitHub Actions или GitLab CI). Пример конфигурации:

```yaml
test:
  stage: test
  script:
    - ./tests/run_tests.sh
  artifacts:
    paths:
      - docker_test/logs/
    when: on_failure
```

## Решение проблем

### Распространённые ошибки:

1. **Ошибка доступа к Docker**: убедитесь, что ваш пользователь имеет права на взаимодействие с Docker.
   ```bash
   sudo usermod -aG docker $USER
   ```

2. **Ошибки сборки образа**: проверьте Dockerfile и Docker Compose, убедитесь, что все пути корректны.

3. **Ошибки в тестах**: проверьте логи выполнения тестов для определения причины сбоя.

## Расширение тестов

Для добавления новых тестов:

1. Добавьте новые методы тестирования в существующие классы
2. Создайте новые mock-объекты для внешних зависимостей
3. Обновите тестовые данные в соответствии с вашими требованиями

## Заключение

Интеграционное тестирование в Docker позволяет проверить, что все компоненты правильно работают вместе в изолированной среде перед развертыванием в production. Это снижает риск возникновения ошибок и улучшает качество программного обеспечения.
