# Руководство по тестированию с реальными зависимостями

Данное руководство описывает процесс полного интеграционного тестирования Photo Agent с использованием реальных подключений к SharePoint и OpenAI API.

## Важная информация

**Внимание:** Тесты с реальными зависимостями:
1. Выполняют запросы к внешним сервисам, которые могут быть платными (OpenAI API)
2. Воздействуют на реальные библиотеки SharePoint, что может привести к изменению данных
3. Создают и удаляют файлы в библиотеках SharePoint

Используйте эти тесты только в тестовых окружениях с тестовыми учетными данными!

## Необходимые компоненты

1. **Учетные данные для внешних сервисов**:
   - Работающие учетные данные SharePoint (указанные в config.env)
   - Действующий API-ключ OpenAI (указанный в config.env)
   
2. **Программное обеспечение**:
   - Python 3.8 или выше
   - Docker и Docker Compose (для Docker-тестов)
   - Модули Python: unittest, pytest, pytest-mock

## Настройка перед запуском

1. Убедитесь, что файл `config/config.env` содержит правильные учетные данные для SharePoint и OpenAI API.

2. Рекомендуется перед запуском тестов изменить следующие параметры в config.env:
   - `SOURCE_LIBRARY_TITLE` - используйте тестовую библиотеку для источника
   - `SHAREPOINT_LIBRARY` - используйте тестовую библиотеку для результатов
   - `TARGET_FILENAME_MASK` - добавьте префикс "TEST_" к маске имени файла
   - `OPENAI_CONCURRENCY_LIMIT` - установите более низкое значение (например, 1 или 2) для экономии API-запросов

## Запуск тестов

### Запуск через скрипты

Для запуска всех тестов с реальными зависимостями:

**Linux/Mac**:
```bash
./tests/run_real_tests.sh
```

**Windows**:
```cmd
tests\run_real_tests.bat
```

Для запуска только определенного типа тестов:

- Только интеграционные тесты (без Docker): `./tests/run_real_tests.sh integration`
- Только Docker-тесты: `./tests/run_real_tests.sh docker`

### Запуск вручную

Если вы хотите запустить тесты вручную:

1. **Интеграционные тесты**:
   ```bash
   python -m unittest tests/test_real_integration.py
   ```

2. **Docker-тесты**:
   ```bash
   python -m unittest tests/test_real_docker.py
   ```

## Описание тестов

### Интеграционные тесты (test_real_integration.py)

Эти тесты проверяют все компоненты приложения с использованием реальных подключений:

1. `test_1_metadata_schema`: Извлечение схемы метаданных из реальной библиотеки SharePoint
2. `test_2_photo_download`: Скачивание фотографий из исходной библиотеки
3. `test_3_openai_analysis`: Анализ фотографий с помощью реального API OpenAI
4. `test_4_metadata_generation`: Генерация метаданных на основе анализа
5. `test_5_upload_to_sharepoint`: Загрузка фотографий в целевую библиотеку SharePoint
6. `test_6_transfer_verification`: Проверка результатов загрузки
7. `test_7_full_process`: Проверка полного процесса обработки

### Docker-тесты (test_real_docker.py)

Эти тесты проверяют работу приложения внутри Docker-контейнера с использованием реальных подключений:

1. `test_01_container_environment`: Проверка окружения контейнера
2. `test_02_test_connections`: Проверка подключений к SharePoint и OpenAI
3. `test_03_metadata_schema`: Тестирование извлечения схемы метаданных
4. `test_04_photo_metadata`: Тестирование скачивания фотографий
5. `test_05_openai_analyzer`: Тестирование анализатора OpenAI
6. `test_06_metadata_generator`: Тестирование генератора метаданных
7. `test_07_sharepoint_uploader`: Тестирование загрузки в SharePoint
8. `test_08_auto_process`: Тестирование полного процесса

## Анализ результатов

Скрипты тестирования создают подробные логи о выполнении каждого шага. После завершения тестов вы можете проверить:

1. **Директории с данными**:
   - `data/downloads/` - скачанные фотографии
   - `data/metadata/` - извлеченные метаданные
   - `data/analysis/` - результаты анализа OpenAI
   - `data/upload/` - файлы, подготовленные для загрузки
   - `data/uploaded/` - загруженные файлы

2. **Docker-тестовые данные**:
   - `real_docker_test/` - директория с данными Docker-тестов

3. **Логи**:
   - `logs/` - журналы выполнения

## Решение проблем

### Распространенные ошибки:

1. **Ошибки подключения к SharePoint**:
   - Проверьте правильность URL, имени пользователя и пароля
   - Убедитесь, что у пользователя есть доступ к указанным библиотекам
   - Проверьте, что библиотеки действительно существуют

2. **Ошибки подключения к OpenAI API**:
   - Проверьте правильность API-ключа
   - Убедитесь, что у API-ключа достаточно квоты
   - Проверьте, что указанная модель доступна

3. **Ошибки в Docker-тестах**:
   - Убедитесь, что Docker и Docker Compose установлены
   - Проверьте, что сервис Docker запущен
   - Убедитесь, что у пользователя есть права на использование Docker

## Рекомендации

1. **Перед запуском тестов в production**:
   - Всегда запускайте тесты в тестовом окружении
   - Используйте тестовые библиотеки SharePoint
   - Ограничьте количество файлов, обрабатываемых за один тест

2. **Для экономии API-запросов**:
   - Установите низкое значение `OPENAI_CONCURRENCY_LIMIT`
   - Используйте тестовые файлы небольшого размера
   - Запускайте только те тесты, которые вам нужны в данный момент

3. **После завершения тестов**:
   - Проверьте целевую библиотеку SharePoint на наличие тестовых файлов
   - При необходимости удалите тестовые файлы из SharePoint
   - Очистите тестовые директории с помощью скрипта очистки

## Расширение тестов

Если вы хотите добавить новые тесты с реальными зависимостями:

1. Добавьте новые методы тестирования в классы `RealIntegrationTest` или `DockerRealIntegrationTest`
2. Следуйте шаблону существующих тестов для сохранения согласованности
3. Обновите документацию, добавив описание новых тестов
