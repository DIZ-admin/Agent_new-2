# Технический отчет по проекту Photo Agent для SharePoint

## Резюме проекта

Photo Agent для SharePoint представляет собой автоматизированную систему для обработки и загрузки фотографий в SharePoint с использованием искусственного интеллекта для анализа и обогащения метаданных. Система разработана для оптимизации рабочего процесса управления фотографиями строительных и архитектурных проектов компании ERNI, специализирующейся на деревянных конструкциях.

## Ключевые возможности

1. **Автоматизированная передача**: Перемещение фотографий из исходной библиотеки SharePoint в целевую
2. **Извлечение метаданных**: Извлечение EXIF-данных и других метаданных из фотографий
3. **Анализ с помощью ИИ**: Использование OpenAI GPT-4 Vision для анализа фотографий и генерации релевантных метаданных
4. **Обогащение метаданных**: Объединение EXIF-данных с анализом ИИ для создания комплексных метаданных
5. **Интеграция с SharePoint**: Загрузка фотографий с расширенными метаданными в целевую библиотеку SharePoint
6. **Верификация**: Проверка успешных передач и генерация отчетов
7. **Веб-интерфейс**: Удобный интерфейс для управления всеми процессами и настройками системы

## Архитектура системы

Система следует модульной архитектуре со следующими основными компонентами:

### Серверные компоненты (Python)

1. **Модуль аутентификации SharePoint** (`sharepoint_auth.py`)
   - Управляет подключением и аутентификацией в SharePoint
   - Используется всеми другими модулями, взаимодействующими с SharePoint

2. **Анализатор схемы метаданных** (`metadata_schema.py`)
   - Извлекает схему метаданных из целевой библиотеки SharePoint
   - Сохраняет схему в JSON для использования другими модулями

3. **Экстрактор метаданных фотографий** (`photo_metadata.py`)
   - Загружает фотографии из исходной библиотеки SharePoint
   - Извлекает EXIF и другие метаданные
   - Сохраняет фотографии в локальное хранилище

4. **Анализатор OpenAI** (`openai_analyzer.py`)
   - Анализирует фотографии с использованием OpenAI GPT-4 Vision
   - Генерирует метаданные на основе визуального содержимого
   - Следует схеме целевой библиотеки SharePoint

5. **Генератор метаданных** (`metadata_generator.py`)
   - Объединяет EXIF-данные с анализом OpenAI
   - Форматирует метаданные в соответствии с требованиями SharePoint

6. **Загрузчик SharePoint** (`sharepoint_uploader.py`)
   - Загружает фотографии с метаданными в целевую библиотеку SharePoint
   - Управляет именованием файлов и организацией

7. **Верификация передачи** (`transfer_verification.py`)
   - Проверяет успешные передачи
   - Генерирует отчеты о процессе

8. **Оркестратор автоматического процесса** (`auto_process.py`)
   - Оркестрирует весь рабочий процесс
   - Запускает все скрипты последовательно
   - Управляет логированием и обработкой ошибок

### Компоненты интерфейса (Flask/Jinja2)

Веб-интерфейс построен с использованием Flask и шаблонов Jinja2, предоставляя компоненты для:

1. **Дашборд** - Обзор и быстрый доступ к функциям
2. **Управление фотографиями** - Просмотр и анализ фотографий
3. **Управление процессами** - Мониторинг процессов
4. **Управление настройками** - Конфигурация системы
5. **Просмотр логов** - Мониторинг и управление логами

## Поток данных

1. Система получает схему метаданных из целевой библиотеки SharePoint
2. Фотографии загружаются из исходной библиотеки SharePoint
3. EXIF-метаданные извлекаются из фотографий
4. Фотографии анализируются с использованием OpenAI GPT-4 Vision
5. Метаданные генерируются путем объединения EXIF-данных и анализа OpenAI
6. Фотографии с обогащенными метаданными загружаются в целевую библиотеку SharePoint
7. Система проверяет успешные передачи и генерирует отчеты

## Структура проекта

```
/
├── config/                  # Конфигурационные файлы
│   ├── config.env           # Переменные окружения
│   ├── sharepoint_choices.json  # Схема метаданных SharePoint
│   ├── default_prompt.env   # Промпт по умолчанию для OpenAI
│   ├── optimized_prompt.env # Оптимизированный промпт для OpenAI
│   ├── step_by_step_prompt.env # Пошаговый промпт для OpenAI
│   └── structured_simple_prompt.env # Структурированный простой промпт для OpenAI
├── data/                    # Хранилище данных
│   ├── downloads/           # Загруженные фотографии
│   ├── metadata/            # Извлеченные метаданные
│   ├── analysis/            # Результаты анализа OpenAI
│   ├── upload/              # Файлы, подготовленные для загрузки
│   │   └── metadata/        # Метаданные для загрузки
│   ├── uploaded/            # Успешно загруженные файлы
│   ├── processed/           # Обработанные файлы
│   ├── registry/            # Реестр файлов
│   └── reports/             # Отчеты о передаче
├── docs/                    # Документация
├── logs/                    # Файлы логов
├── src/                     # Исходный код Python
│   ├── auto_process.py      # Скрипт оркестрации
│   ├── metadata_generator.py # Генерация метаданных
│   ├── metadata_schema.py   # Анализатор схемы
│   ├── openai_analyzer.py   # Анализ фотографий с помощью ИИ
│   ├── photo_metadata.py    # Извлечение метаданных фотографий
│   ├── process_wrapper.py   # Обертка процесса
│   ├── sharepoint_auth.py   # Аутентификация SharePoint
│   ├── sharepoint_uploader.py # Загрузка в SharePoint
│   ├── transfer_verification.py # Верификация
│   ├── web_server.py        # Веб-сервер
│   ├── utils/               # Утилитные модули
│   │   ├── api.py           # Утилиты API
│   │   ├── config.py        # Утилиты конфигурации
│   │   ├── logging.py       # Утилиты логирования
│   │   ├── paths.py         # Утилиты путей
│   │   ├── process_tracker.py # Отслеживание процессов
│   │   ├── registry.py      # Реестр файлов
│   │   └── sharepoint.py    # Утилиты SharePoint
│   └── web/                 # Веб-интерфейс (Flask)
│       ├── app.py           # Приложение Flask
│       ├── file_cache.py    # Кэширование файлов
│       ├── file_manager.py  # Управление файлами
│       ├── process_monitor.py # Мониторинг процессов
│       ├── templates/       # HTML-шаблоны
│       │   ├── base.html    # Базовый шаблон
│       │   ├── main/        # Основные шаблоны
│       │   ├── photos/      # Шаблоны фотографий
│       │   ├── processes/   # Шаблоны процессов
│       │   └── settings/    # Шаблоны настроек
│       └── views/           # Функции представления
│           ├── logs.py      # Представления логов
│           ├── main.py      # Основные представления
│           ├── photos.py    # Представления фотографий
│           ├── processes.py # Представления процессов
│           └── settings.py  # Представления настроек
└── tests/                   # Тестовые файлы
```

## Конфигурация

Система настраивается через переменные окружения в `config.env`:

- **Подключение к SharePoint**: URL сайта, имя пользователя, пароль
- **Настройки библиотеки**: Имена исходной и целевой библиотек
- **Настройки файлов**: Файл схемы метаданных, маска имени целевого файла, максимальный размер файла
- **Настройки OpenAI**: API-ключ, лимит параллельных запросов, максимальное количество токенов

## Ключевые технологии

- **Бэкенд**: Python с библиотеками для интеграции с SharePoint (Office365-REST-Python-Client), обработки изображений (Pillow) и ИИ (OpenAI API)
- **Фронтенд**: Flask, шаблоны Jinja2, Bootstrap 5, jQuery
- **Хранилище**: Локальная файловая система (временное) и SharePoint (постоянное)
- **API**: SharePoint REST API, OpenAI API
- **Контейнеризация**: Docker и Docker Compose для упрощения развертывания

## Интеграция с OpenAI

Анализатор OpenAI является ключевым компонентом, который:

1. Принимает фотографии в качестве входных данных
2. Отправляет их в модель OpenAI GPT-4 Vision со специализированным промптом
3. Инструктирует ИИ анализировать фотографии с точки зрения строительства/архитектуры
4. Генерирует метаданные в соответствии со схемой целевой библиотеки SharePoint
5. Обрабатывает ответ ИИ в структурированный формат
6. Сохраняет результаты анализа для дальнейшей обработки

Инженерия промптов специально адаптирована для извлечения релевантных строительных и архитектурных деталей из фотографий.

## Интеграция с SharePoint

Система взаимодействует с SharePoint через:

1. **Аутентификация**: OAuth-поток для безопасного доступа
2. **Анализ схемы**: Динамическое извлечение схемы метаданных
3. **Загрузка фотографий**: Эффективное получение из исходной библиотеки
4. **Загрузка метаданных**: Правильно форматированная отправка метаданных
5. **Верификация**: Подтверждение успешных передач

## Веб-интерфейс

Веб-интерфейс предоставляет удобный способ управления системой:

1. **Дашборд** - Общая статистика и быстрый доступ к основным функциям
2. **Фотографии** - Управление фотографиями в системе
   - Вкладка "Загрузки" - Фотографии, загруженные из SharePoint
   - Вкладка "Анализ" - Результаты анализа фотографий с помощью OpenAI
   - Вкладка "Загрузка" - Фотографии, подготовленные для загрузки в SharePoint
   - Вкладка "Загружено" - Фотографии, успешно загруженные в SharePoint
3. **Логи** - Просмотр и управление логами системы
4. **Процессы** - Запуск и мониторинг процессов обработки
5. **Настройки** - Настройка системы
   - Настройки SharePoint
   - Настройки OpenAI API
   - Настройки промптов для OpenAI
   - Настройки параметров модели OpenAI
   - Очистка директорий с данными

## Рабочий процесс

1. **Инициализация и конфигурация**
   - Загрузка системы и инициализация необходимых директорий
   - Загрузка конфигурации (SharePoint, OpenAI, промпты, схема метаданных)

2. **Загрузка схемы метаданных из SharePoint**
   - Подключение к SharePoint
   - Извлечение схемы метаданных из библиотеки "Референсфото"
   - Сохранение схемы в JSON-файл

3. **Загрузка фотографий из SharePoint**
   - Получение списка фотографий из исходной библиотеки
   - Загрузка фотографий пакетами
   - Извлечение EXIF-метаданных
   - Сохранение метаданных в YAML-файлы

4. **Анализ фотографий с помощью OpenAI**
   - Подготовка промпта с включением EXIF-данных
   - Оптимизация изображений перед отправкой
   - Отправка запросов к OpenAI API
   - Сохранение результатов анализа в JSON-файлы

5. **Генерация метаданных для загрузки в SharePoint**
   - Генерация новых имен файлов
   - Интеллектуальное объединение данных из разных источников
   - Геокодирование GPS-координат
   - Валидация значений полей согласно схеме SharePoint

6. **Загрузка фотографий в SharePoint**
   - Загрузка файлов в целевую библиотеку
   - Обновление метаданных файлов
   - Обновление реестра загруженных файлов

7. **Автоматизированный процесс**
   - Последовательный запуск всех модулей
   - Обработка ошибок на каждом этапе
   - Логирование всех действий

## Технические особенности

1. **Обработка EXIF-метаданных**
   - Извлечение метаданных с помощью библиотеки PIL
   - Форматирование GPS-координат в читаемый формат
   - Использование метаданных для обогащения промпта OpenAI

2. **Интеллектуальное объединение данных**
   - Определение приоритетов источников для различных полей
   - Маппинг EXIF-тегов на поля SharePoint
   - Геокодирование GPS-координат

3. **Оптимизация производительности**
   - Пакетная обработка файлов
   - Параллельная обработка с использованием ThreadPoolExecutor
   - Кэширование результатов
   - Механизмы повторных попыток

4. **Отказоустойчивость**
   - Обработка ошибок на каждом этапе
   - Логирование всех действий
   - Сохранение промежуточных результатов
   - Реестр обработанных файлов для избежания повторной обработки

## Развертывание и запуск

### Предварительные требования

- Docker и Docker Compose
- Учетные данные SharePoint
- API-ключ OpenAI

### Запуск в Docker

1. Создайте или отредактируйте файл `config/config.env` с вашими параметрами
2. Запустите приложение с помощью Docker Compose:
   ```
   docker-compose up -d
   ```
3. Откройте веб-интерфейс по адресу `http://localhost:8080`

## Мониторинг и отчеты

- Логи сохраняются в каталоге `logs/`
- Отчеты о результатах загрузки сохраняются в `data/reports/`
- Для проверки состояния системы используйте веб-интерфейс

## Обслуживание

### Очистка данных

Для очистки временных данных используйте веб-интерфейс (раздел "Настройки" -> "Очистка данных") или выполните:
```
docker-compose exec agent rm -rf /app/data/downloads/* /app/data/metadata/* /app/data/analysis/* /app/data/upload/*
```

### Обновление

1. Остановите контейнер: `docker-compose down`
2. Пересоберите образ: `docker-compose build --no-cache`
3. Запустите обновленный контейнер: `docker-compose up -d`

## Заключение

Photo Agent для SharePoint представляет собой комплексное решение для автоматизации обработки фотографий строительных проектов. Система интегрирует различные технологии (SharePoint, OpenAI, геокодирование) для создания полного цикла обработки фотографий с минимальным вмешательством человека.

Ключевыми особенностями являются интеллектуальное объединение данных из различных источников, использование искусственного интеллекта для анализа изображений и автоматическое обогащение метаданных с учетом контекста фотографий.

Система спроектирована с учетом масштабируемости, отказоустойчивости и производительности, что обеспечивает эффективную и надежную обработку больших объемов фотографий.
