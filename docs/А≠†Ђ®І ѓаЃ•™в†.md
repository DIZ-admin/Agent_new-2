Детальный аудит кода и схема работы проекта
Общее описание проекта
Проект представляет собой автоматизированную систему для обработки фотографий деревянных конструкций с использованием искусственного интеллекта. Система выполняет следующие основные функции:

Загрузка фотографий из библиотеки SharePoint
Извлечение метаданных из фотографий (EXIF)
Анализ фотографий с помощью OpenAI (GPT-4o)
Генерация структурированных метаданных на основе анализа
Загрузка обработанных фотографий с метаданными в целевую библиотеку SharePoint
Архитектура проекта
Проект имеет модульную архитектуру и состоит из следующих основных компонентов:

1. Основные модули обработки:
auto_process.py - главный модуль, координирующий весь процесс
metadata_schema.py - получение схемы метаданных из SharePoint
photo_metadata.py - загрузка фотографий и извлечение EXIF-метаданных
openai_analyzer.py - анализ фотографий с помощью OpenAI
metadata_generator.py - генерация метаданных для загрузки
sharepoint_uploader.py - загрузка фотографий в SharePoint
transfer_verification.py - проверка результатов загрузки
2. Вспомогательные модули (utils):
config.py - управление конфигурацией
logging.py - настройка логирования
paths.py - управление путями и файловыми операциями
registry.py - реестр обработанных файлов
api.py - утилиты для работы с API
sharepoint.py - утилиты для работы с SharePoint
3. Структура данных:
/config - конфигурационные файлы
/data - директории для хранения данных:
/downloads - загруженные фотографии
/metadata - извлеченные метаданные
/analysis - результаты анализа OpenAI
/upload - файлы, готовые к загрузке
/uploaded - загруженные файлы
/reports - отчеты о загрузке
/registry - реестр обработанных файлов
4. Конфигурация:
config.env - основной конфигурационный файл с настройками
sharepoint_choices.json - схема метаданных SharePoint
Пошаговая схема работы проекта
Шаг 1: Инициализация и загрузка конфигурации
Загрузка переменных окружения из config.env
Инициализация логгера
Создание необходимых директорий
Проверка доступности SharePoint и OpenAI
Шаг 2: Получение схемы метаданных (metadata_schema.py)
Подключение к SharePoint с использованием учетных данных
Получение целевой библиотеки SharePoint
Извлечение схемы полей метаданных из библиотеки
Сохранение схемы в файл sharepoint_choices.json
Шаг 3: Загрузка и обработка фотографий (photo_metadata.py)
Подключение к исходной библиотеке SharePoint
Получение списка фотографий из библиотеки
Загрузка фотографий в директорию /data/downloads
Извлечение EXIF-метаданных из каждой фотографии
Сохранение метаданных в формате YAML в директорию /data/metadata
Опционально: удаление фотографий из исходной библиотеки после обработки
Шаг 4: Анализ фотографий с помощью OpenAI (openai_analyzer.py)
Загрузка API-ключа OpenAI из конфигурации
Формирование промпта для анализа фотографий (эксперт по деревянным конструкциям)
Обработка фотографий из директории /data/downloads партиями
Для каждой фотографии:
Кодирование изображения в base64
Отправка запроса к OpenAI API (модель GPT-4o)
Получение и парсинг результатов анализа
Сохранение результатов в формате JSON в директорию /data/analysis
Шаг 5: Генерация метаданных для загрузки (metadata_generator.py)
Загрузка схемы метаданных из sharepoint_choices.json
Поиск обработанных фотографий (имеющих файлы анализа)
Для каждой фотографии:
Генерация целевого имени файла по маске Erni_Referenzfoto_{number}
Объединение EXIF-метаданных и результатов анализа OpenAI
Валидация метаданных согласно схеме SharePoint
Сохранение метаданных в формате JSON в директорию /data/upload/metadata
Копирование фотографии в директорию /data/upload
Шаг 6: Загрузка в SharePoint (sharepoint_uploader.py)
Подключение к целевой библиотеке SharePoint
Получение списка файлов для загрузки из директории /data/upload
Для каждого файла:
Загрузка файла в SharePoint
Обновление метаданных файла в SharePoint
Загрузка файла метаданных в SharePoint
Перемещение файла и метаданных в директорию /data/uploaded
Обновление реестра загруженных файлов
Шаг 7: Проверка результатов (transfer_verification.py)
Подключение к целевой библиотеке SharePoint
Получение списка загруженных файлов из директории /data/uploaded
Проверка наличия каждого файла в SharePoint
Проверка корректности метаданных
Генерация отчета о результатах загрузки
Ключевые особенности реализации
Обработка ошибок и повторные попытки
Система включает механизмы повторных попыток для API-запросов
Логирование всех ошибок и предупреждений
Обработка исключений на каждом этапе
Параллельная обработка
Использование ThreadPoolExecutor для параллельной обработки фотографий
Ограничение количества одновременных запросов к OpenAI
Атомарные операции с файлами
Использование временных файлов для предотвращения повреждения данных
Перемещение файлов между директориями только после успешного завершения операций
Реестр обработанных файлов
Отслеживание обработанных и загруженных файлов
Предотвращение повторной обработки одних и тех же файлов
Сохранение информации о загрузке для последующей проверки
Конфигурация и настройка
Централизованное управление конфигурацией через файл config.env
Возможность настройки параметров OpenAI, SharePoint и обработки файлов
Валидация конфигурации при запуске
Запуск проекта
Проект может быть запущен несколькими способами:

1. Полный автоматический процесс
или через Docker:

2. Запуск отдельных этапов
Получение схемы метаданных: python -m src.metadata_schema
Загрузка фотографий: python -m src.photo_metadata
Анализ с OpenAI: python -m src.openai_analyzer
Генерация метаданных: python -m src.metadata_generator
Загрузка в SharePoint: python -m src.sharepoint_uploader
Проверка результатов: python -m src.transfer_verification
3. Через скрипты запуска
Windows: run.bat [команда]
Linux/Mac: run.sh [команда]
Где команда может быть: photos, analyze, metadata, upload, verify, build

Заключение
Проект представляет собой хорошо структурированную систему для автоматизированной обработки фотографий с использованием искусственного интеллекта. Он имеет модульную архитектуру, что обеспечивает гибкость и расширяемость. Система включает механизмы обработки ошибок, логирования и мониторинга, что делает ее надежной и устойчивой к сбоям.

Основная ценность проекта заключается в автоматизации процесса анализа фотографий деревянных конструкций и генерации структурированных метаданных для SharePoint, что значительно упрощает и ускоряет работу с большими объемами фотографий.