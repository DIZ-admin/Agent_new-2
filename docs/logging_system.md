# Система логирования в ERNI Photo Processor

## Обзор

Система логирования в ERNI Photo Processor теперь использует файлы логов с датами в имени файла. Это позволяет:

1. Легко отслеживать логи по датам
2. Автоматически ротировать старые логи
3. Сохранять историю логов для анализа
4. Отслеживать использование токенов OpenAI API

## Структура файлов логов

Логи сохраняются в директории `logs/` в следующем формате:

- `erni_photo_processor_YYYY-MM-DD.log` - лог за конкретную дату
- `erni_photo_processor.log` - символическая ссылка на последний лог (для обратной совместимости)
- `token_usage_stats.json` - статистика использования токенов OpenAI API

## Формат сообщений

Каждое сообщение в логе содержит:

- Дату и время (`YYYY-MM-DD HH:MM:SS,mmm`)
- Имя логгера (модуль, который создал сообщение)
- Уровень сообщения (INFO, WARNING, ERROR, DEBUG)
- Текст сообщения

Пример:
```
2023-04-10 14:25:33,123 - auto_process - INFO - Starting automatic photo processing
```

## Ротация логов

Система автоматически удаляет старые логи, чтобы они не занимали слишком много места. По умолчанию, логи хранятся 30 дней, после чего удаляются.

Ротация логов происходит при каждом запуске `auto_process.py`.

## Уровни логирования

Система поддерживает следующие уровни логирования:

- `DEBUG` - детальная информация для отладки
- `INFO` - общая информация о работе системы
- `WARNING` - предупреждения, которые не прерывают работу
- `ERROR` - ошибки, которые могут прервать работу
- `CRITICAL` - критические ошибки, которые прерывают работу

Уровень логирования можно настроить в файле `config.env` с помощью параметра `LOG_LEVEL`.

## Просмотр логов

Для просмотра логов можно использовать:

1. Команду `./run.sh logs` или `run.bat logs` для просмотра текущего лога
2. Любой текстовый редактор для просмотра конкретного лога по дате

## Настройка

Настройки логирования находятся в файле `config.env`:

- `LOG_LEVEL` - уровень логирования (INFO, DEBUG, WARNING, ERROR, CRITICAL)
- `LOG_FILE` - базовое имя файла лога (без даты)

## Программный интерфейс

Для использования логирования в коде:

```python
from src.utils.logging import get_logger

# Создание логгера для модуля
logger = get_logger(__name__)

# Логирование сообщений
logger.debug("Отладочная информация")
logger.info("Информационное сообщение")
logger.warning("Предупреждение")
logger.error("Ошибка")
logger.critical("Критическая ошибка")
```

Для ротации логов вручную:

```python
from src.utils.logging import rotate_logs

# Удалить логи старше 30 дней
rotate_logs(max_days=30)
```

## Статистика использования токенов OpenAI API

Система теперь отслеживает использование токенов OpenAI API и сохраняет статистику в файл `logs/token_usage_stats.json`. Это позволяет:

1. Отслеживать общее количество использованных токенов
2. Отслеживать использование токенов по моделям
3. Отслеживать скорость использования токенов
4. Сохранять историю использования токенов

Статистика сохраняется в формате JSON и содержит следующие данные:

```json
{
  "total_prompt_tokens": 7040,
  "total_completion_tokens": 721,
  "total_tokens": 7761,
  "request_count": 3,
  "error_count": 0,
  "start_time": 1744704988.3244898,
  "last_update": 1744704997.061678,
  "model_usage": {
    "gpt-4o": {
      "prompt_tokens": 7040,
      "completion_tokens": 721,
      "total_tokens": 7761,
      "request_count": 3
    }
  },
  "usage_history": []
}
```

Статистика автоматически обновляется при каждом запросе к OpenAI API и сохраняется между запусками скриптов. Это позволяет отслеживать использование токенов даже при запуске скриптов в разных процессах.

Статистику использования токенов можно просмотреть в веб-интерфейсе в разделе "Настройки" -> "Token Usage".

## Отслеживание прогресса

Для отслеживания прогресса длительных операций можно использовать `ProgressLogger`:

```python
from src.utils.logging import ProgressLogger

# Создание логгера прогресса
progress = ProgressLogger("operation_name", total=100)

# Обновление прогресса
for i in range(100):
    # Выполнение операции
    progress.update(1, f"Processed item {i+1}")

# Завершение операции
progress.complete("All done!")
```
