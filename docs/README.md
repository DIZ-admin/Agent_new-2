# Система переноса фотографий из SharePoint в SharePoint с обработкой метаданных

Данная система предназначена для переноса фотографий из исходной библиотеки SharePoint в целевую библиотеку с добавлением метаданных, полученных с помощью анализа изображений через OpenAI API с позиции эксперта по деревянному строительству.

## Общая архитектура системы

Система состоит из нескольких модулей, каждый из которых отвечает за определенный этап процесса:

1. **Аутентификация в SharePoint** (`sharepoint_auth.py`) - модуль для подключения к SharePoint и получения доступа к библиотекам.
2. **Анализ структуры метаданных** (`metadata_schema.py`) - модуль для извлечения схемы метаданных из целевой библиотеки.
3. **Обработка исходных фотографий** (`photo_metadata.py`) - модуль для загрузки фотографий из исходной библиотеки и извлечения EXIF-метаданных.
4. **Анализ с помощью OpenAI API** (`openai_analyzer.py`) - модуль для анализа фотографий с помощью OpenAI API с позиции эксперта по деревянному строительству.
5. **Генерация метаданных** (`metadata_generator.py`) - модуль для формирования JSON-файлов с метаданными по схеме целевой библиотеки.
6. **Загрузка в целевую библиотеку** (`sharepoint_uploader.py`) - модуль для загрузки фотографий в целевую библиотеку с переименованием и добавлением метаданных.
7. **Верификация и отчетность** (`transfer_verification.py`) - модуль для проверки корректности переноса и формирования отчета.
8. **Веб-интерфейс** (`web_server.py`) - модуль для запуска веб-интерфейса для управления системой.

## Настройка и конфигурация

Все настройки системы хранятся в файле `config/config.env`. Основные параметры:

- **Настройки подключения к SharePoint**: URL сайта, имя пользователя и пароль
- **Настройки библиотек**: названия исходной и целевой библиотек
- **Настройки файлов**: маска имени файла, максимальный размер файла
- **Настройки OpenAI API**: ключ API, ограничение параллельных запросов, максимальное количество токенов
- **Настройки промпта для OpenAI**: тип промпта, модель, температура, детализация изображения

Промпты для OpenAI хранятся в отдельных файлах в директории `config/prompts/`. Каждый файл содержит настройки для определенного типа промпта:

- `minimal_prompt.env` - минимальный промпт
- `structured_simple_prompt.env` - структурированный простой промпт
- `accuracy_focused_prompt.env` - промпт, ориентированный на точность
- `examples_prompt.env` - промпт с примерами
- `step_by_step_prompt.env` - пошаговый промпт
- `optimized_prompt.env` - оптимизированный промпт

## Порядок использования

### 1. Подготовка

Перед началом работы убедитесь, что файл `config/config.env` содержит корректные настройки:

```
# SharePoint connection settings
SHAREPOINT_SITE_URL=https://erni.sharepoint.com/sites/100_Testing_KI-Projekte
SHAREPOINT_USERNAME=test.ki@erni-gruppe.ch
SHAREPOINT_PASSWORD=dHe3zDq%

# Library settings
SOURCE_LIBRARY_TITLE=PhotoLibrary
SHAREPOINT_LIBRARY=Fertige Referenzfotos

# File settings
METADATA_SCHEMA_FILE=config/sharepoint_choices.json
TARGET_FILENAME_MASK=Erni_Referenzfoto_{number}
MAX_FILE_SIZE=15728640

# OpenAI settings
OPENAI_API_KEY=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
OPENAI_CONCURRENCY_LIMIT=10
MAX_TOKENS="1000"

# OpenAI Prompt settings
OPENAI_PROMPT_TYPE="structured_simple"
MODEL_NAME="gpt-4o"
TEMPERATURE="0.1"
IMAGE_DETAIL="high"
```

### 2. Запуск через Docker

Система поставляется с настроенными Docker-контейнерами для удобного запуска:

```bash
docker-compose up -d
```

Это запустит два контейнера:
- `photo-agent` - основной процесс обработки фотографий
- `photo-web` - веб-интерфейс для управления системой

Веб-интерфейс будет доступен по адресу [http://localhost:8080](http://localhost:8080).

### 3. Запуск отдельных модулей

Если вы хотите запустить отдельные модули системы, вы можете использовать следующие команды:

```bash
# Извлечение схемы метаданных
python -m src.metadata_schema

# Загрузка и обработка фотографий
python -m src.photo_metadata

# Анализ фотографий с помощью OpenAI API
python -m src.openai_analyzer

# Генерация метаданных для загрузки
python -m src.metadata_generator

# Загрузка фотографий в целевую библиотеку
python -m src.sharepoint_uploader

# Проверка корректности переноса
python -m src.transfer_verification

# Запуск всего процесса автоматически
python -m src.auto_process

# Запуск веб-интерфейса
python -m src.web_server
```

## Веб-интерфейс

Веб-интерфейс предоставляет удобный способ управления системой через браузер. Он доступен по адресу [http://localhost:8080](http://localhost:8080) после запуска контейнеров.

### Основные функции веб-интерфейса:

1. **Дашборд** - общая статистика и быстрый доступ к основным функциям
2. **Фотографии** - управление фотографиями в системе
   - Вкладка "Загрузки" - фотографии, загруженные из SharePoint
   - Вкладка "Анализ" - результаты анализа фотографий с помощью OpenAI
   - Вкладка "Загрузка" - фотографии, подготовленные для загрузки в SharePoint
   - Вкладка "Загружено" - фотографии, успешно загруженные в SharePoint
3. **Логи** - просмотр и управление логами системы
4. **Процессы** - запуск и мониторинг процессов обработки
5. **Настройки** - настройка системы
   - Настройки SharePoint
   - Настройки OpenAI API
   - Настройки промптов для OpenAI
   - Настройки параметров модели OpenAI
   - Очистка директорий с данными

## Структура директорий

- `config/` - конфигурационные файлы
  - `config.env` - основной файл конфигурации
  - `prompts/` - файлы с промптами для OpenAI
  - `sharepoint_choices.json` - схема метаданных SharePoint
- `data/` - директории для хранения данных
  - `downloads/` - загруженные фотографии из исходной библиотеки
  - `metadata/` - извлеченные EXIF-метаданные
  - `analysis/` - результаты анализа фотографий с помощью OpenAI API
  - `upload/` - фотографии, подготовленные для загрузки в целевую библиотеку
  - `upload/metadata/` - метаданные для загрузки
  - `uploaded/` - успешно загруженные фотографии
  - `processed/` - обработанные фотографии
  - `registry/` - реестр обработанных файлов
  - `reports/` - отчеты о результатах переноса
- `logs/` - журналы логирования
- `src/` - исходный код системы
  - `utils/` - утилиты для работы с конфигурацией, логированием и т.д.
  - `web/` - веб-интерфейс на Flask
- `docs/` - документация

## Логирование

Все действия системы логируются в файл `logs/erni_photo_processor.log`. Уровень логирования можно изменить в файле `config/config.env`.

Логи также доступны через веб-интерфейс в разделе "Логи".

## Обработка ошибок

Система обрабатывает различные ошибки, которые могут возникнуть в процессе работы:

- Ошибки подключения к SharePoint
- Ошибки загрузки и обработки фотографий
- Ошибки анализа с помощью OpenAI API
- Ошибки загрузки в целевую библиотеку

Все ошибки логируются в файл `logs/erni_photo_processor.log` и выводятся в консоль, а также отображаются в веб-интерфейсе.

## Требования к системе

- Docker и Docker Compose для запуска контейнеров
- Python 3.8 или выше (если запускаете без Docker)
- Библиотеки: Office365-REST-Python-Client, pillow, python-dotenv, requests, openai, flask, flask-wtf

## Безопасность

- Учетные данные SharePoint и ключ OpenAI API хранятся в файле `config/config.env`
- Файл `config/config.env` не должен включаться в систему контроля версий
- Рекомендуется использовать учетную запись с минимально необходимыми правами доступа
- Веб-интерфейс защищен от CSRF-атак с помощью токенов

## Дальнейшее развитие

Возможные направления развития системы:

1. Добавление аутентификации и авторизации в веб-интерфейс
2. Интеграция с другими системами хранения фотографий
3. Расширение функциональности анализа фотографий
4. Автоматизация процесса переноса по расписанию
5. Добавление поддержки других форматов файлов (видео, документы и т.д.)
6. Добавление возможности редактирования промптов через веб-интерфейс
7. Реализация горячей перезагрузки для разработки
