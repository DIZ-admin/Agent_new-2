# Промпты для OpenAI в ERNI Photo Processor

## Обзор

Система ERNI Photo Processor использует OpenAI API для анализа фотографий и генерации метаданных. Для этого используются специальные промпты, которые определяют, как модель OpenAI должна анализировать фотографии и какие метаданные должна генерировать.

## Структура промптов

Каждый промпт состоит из нескольких частей:

1. **Роль (Role)**: определяет, какую роль должна играть модель при анализе фотографий. Например, "эксперт по деревянному строительству".
2. **Инструкции перед списком полей (Instructions Pre)**: инструкции для модели перед списком полей метаданных.
3. **Инструкции после списка полей (Instructions Post)**: инструкции для модели после списка полей метаданных.
4. **Пример (Example)**: пример ожидаемого формата ответа.

## Хранение промптов

Промпты хранятся в отдельных файлах в корневой директории `config/`. Каждый файл с суффиксом `_prompt.env` содержит настройки для определенного типа промпта:

- `default_prompt.env` - промпт по умолчанию
- `structured_simple_prompt.env` - структурированный простой промпт
- `step_by_step_prompt.env` - пошаговый промпт
- `optimized_prompt.env` - оптимизированный промпт

## Формат файлов промптов

Файлы промптов имеют формат `.env` и содержат следующие переменные:

```
OPENAI_PROMPT_ROLE="Роль модели"
OPENAI_PROMPT_INSTRUCTIONS_PRE="Инструкции перед списком полей"
OPENAI_PROMPT_INSTRUCTIONS_POST="Инструкции после списка полей"
OPENAI_PROMPT_EXAMPLE="Пример ожидаемого формата ответа"
```

## Выбор промпта

Выбор промпта осуществляется через настройки в файле `config/config.env`:

```
OPENAI_PROMPT_TYPE="structured_simple"
```

Также промпт можно выбрать через веб-интерфейс в разделе "Настройки" -> "OpenAI Prompt Settings".

## Использование промптов

При анализе фотографий система выполняет следующие шаги:

1. Загружает выбранный тип промпта из соответствующего файла
2. Загружает схему метаданных из файла `config/sharepoint_choices.json`
3. Формирует полный промпт, включая роль, инструкции, описание полей метаданных и пример
4. Если доступны EXIF-метаданные фотографии, добавляет их в промпт
5. Отправляет промпт и фотографию в OpenAI API
6. Получает и обрабатывает ответ от OpenAI API

## Типы промптов

### Промпт по умолчанию (default)

Промпт по умолчанию содержит базовые инструкции для модели. Он используется как основной промпт, если не выбран другой тип. Он обеспечивает хороший баланс между качеством анализа и затратами токенов.

### Структурированный простой промпт (structured_simple)

Структурированный простой промпт содержит более подробные инструкции для модели, но все еще остается достаточно компактным. Он обеспечивает хороший баланс между качеством анализа и затратами токенов.

### Пошаговый промпт (step_by_step)

Пошаговый промпт содержит инструкции для модели, разбитые на отдельные шаги. Он используется, когда нужно получить более структурированный и последовательный анализ.

### Оптимизированный промпт (optimized)

Оптимизированный промпт содержит инструкции, оптимизированные для конкретной задачи анализа фотографий деревянных конструкций. Он используется, когда нужно получить наилучший результат с учетом специфики предметной области.

## Настройка промптов

Промпты можно настраивать, редактируя соответствующие файлы в директории `config/`. После изменения файлов промптов необходимо перезапустить систему или выбрать промпт заново через веб-интерфейс.

## Рекомендации по созданию промптов

1. **Четко определите роль модели**: укажите, что модель должна действовать как эксперт в конкретной области.
2. **Предоставьте подробные инструкции**: объясните, что именно модель должна анализировать на фотографии.
3. **Укажите формат ответа**: четко опишите, в каком формате должен быть предоставлен ответ.
4. **Предоставьте примеры**: дайте модели примеры ожидаемых ответов.
5. **Учитывайте ограничения**: помните, что промпт и ответ модели ограничены количеством токенов.

## Статистика использования токенов

Система теперь отслеживает использование токенов OpenAI API и сохраняет статистику в файл `logs/token_usage_stats.json`. Это позволяет отслеживать использование токенов даже при запуске скриптов в разных процессах.

Статистика включает в себя:

1. Общее количество токенов в промптах (prompt_tokens)
2. Общее количество токенов в ответах (completion_tokens)
3. Общее количество токенов (total_tokens)
4. Количество запросов (request_count)
5. Количество ошибок (error_count)
6. Статистику по моделям (model_usage)
7. Историю использования токенов (usage_history)

Статистику использования токенов можно просмотреть в веб-интерфейсе в разделе "Настройки" -> "Token Usage".

## Дальнейшее развитие

В текущей версии системы реализована возможность просмотра выбранного промпта через веб-интерфейс и отслеживания использования токенов. В будущих версиях планируется добавить следующие функции:

1. **Тестирование промптов**: возможность тестирования промптов на выбранных фотографиях перед их использованием.
2. **Версионирование промптов**: сохранение истории изменений промптов и возможность возврата к предыдущим версиям.
3. **Библиотека промптов**: создание библиотеки готовых промптов для различных типов фотографий и задач анализа.
4. **Улучшенный интерфейс редактирования**: добавление расширенного редактора с подсветкой синтаксиса и автодополнением.
5. **Расширенная статистика использования токенов**: добавление графиков и детальной аналитики использования токенов.
