{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Settings</h1>
        <p>Configure the ERNI Photo Processor system.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> System Settings</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('settings.update_env') }}" method="post">
                    <h6 class="mb-3">SharePoint Settings</h6>
                    <div class="form-group">
                        <label for="SHAREPOINT_SITE_URL">SharePoint Site URL</label>
                        <input type="text" class="form-control" id="SHAREPOINT_SITE_URL" name="SHAREPOINT_SITE_URL" value="{{ env_vars.SHAREPOINT_SITE_URL }}">
                    </div>
                    <div class="form-group">
                        <label for="SHAREPOINT_USERNAME">SharePoint Username</label>
                        <input type="text" class="form-control" id="SHAREPOINT_USERNAME" name="SHAREPOINT_USERNAME" value="{{ env_vars.SHAREPOINT_USERNAME }}">
                    </div>
                    <div class="form-group">
                        <label for="SHAREPOINT_PASSWORD">SharePoint Password</label>
                        <input type="password" class="form-control" id="SHAREPOINT_PASSWORD" name="SHAREPOINT_PASSWORD" placeholder="Leave blank to keep current password">
                        <small class="form-text text-muted">Leave blank to keep the current password.</small>
                    </div>
                    <div class="form-group">
                        <label for="SOURCE_LIBRARY_TITLE">Source Library Title</label>
                        <input type="text" class="form-control" id="SOURCE_LIBRARY_TITLE" name="SOURCE_LIBRARY_TITLE" value="{{ env_vars.SOURCE_LIBRARY_TITLE }}">
                    </div>
                    <div class="form-group">
                        <label for="SHAREPOINT_LIBRARY">SharePoint Library</label>
                        <input type="text" class="form-control" id="SHAREPOINT_LIBRARY" name="SHAREPOINT_LIBRARY" value="{{ env_vars.SHAREPOINT_LIBRARY }}">
                    </div>

                    <h6 class="mb-3 mt-4">OpenAI Settings</h6>
                    <div class="form-group">
                        <label for="OPENAI_API_KEY">OpenAI API Key</label>
                        <input type="password" class="form-control" id="OPENAI_API_KEY" name="OPENAI_API_KEY" placeholder="Leave blank to keep current API key">
                        <small class="form-text text-muted">Leave blank to keep the current API key.</small>
                    </div>
                    <div class="form-group">
                        <label for="OPENAI_CONCURRENCY_LIMIT">OpenAI Concurrency Limit</label>
                        <input type="number" class="form-control" id="OPENAI_CONCURRENCY_LIMIT" name="OPENAI_CONCURRENCY_LIMIT" value="{{ env_vars.OPENAI_CONCURRENCY_LIMIT }}">
                    </div>

                    <div class="form-group">
                        <label for="MAX_TOKENS">Max Tokens</label>
                        <input type="number" class="form-control" id="MAX_TOKENS" name="MAX_TOKENS" value="{{ env_vars.MAX_TOKENS }}">
                    </div>

                    <h6 class="mb-3 mt-4">Logging Settings</h6>
                    <div class="form-group">
                        <label for="LOG_LEVEL">Log Level</label>
                        <select class="form-control" id="LOG_LEVEL" name="LOG_LEVEL">
                            <option value="DEBUG" {% if env_vars.LOG_LEVEL == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                            <option value="INFO" {% if env_vars.LOG_LEVEL == 'INFO' %}selected{% endif %}>INFO</option>
                            <option value="WARNING" {% if env_vars.LOG_LEVEL == 'WARNING' %}selected{% endif %}>WARNING</option>
                            <option value="ERROR" {% if env_vars.LOG_LEVEL == 'ERROR' %}selected{% endif %}>ERROR</option>
                            <option value="CRITICAL" {% if env_vars.LOG_LEVEL == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="LOG_FILE">Log File</label>
                        <input type="text" class="form-control" id="LOG_FILE" name="LOG_FILE" value="{{ env_vars.LOG_FILE }}">
                    </div>

                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-brain"></i> OpenAI Prompt Settings</h5>
                    </div>
                    <div class="card-body">
                <form action="{{ url_for('settings.update_openai_prompt') }}" method="post">
                    <div class="form-group">
                        <label for="OPENAI_PROMPT_TYPE">Prompt Type</label>
                        <select class="form-control" id="OPENAI_PROMPT_TYPE" name="OPENAI_PROMPT_TYPE">
                            <option value="default" {% if env_vars.OPENAI_PROMPT_TYPE == 'default' %}selected{% endif %}>Default (Standard Config)</option>
                            <option value="minimal" {% if env_vars.OPENAI_PROMPT_TYPE == 'minimal' %}selected{% endif %}>Minimal (Simplest)</option>
                            <option value="structured_simple" {% if env_vars.OPENAI_PROMPT_TYPE == 'structured_simple' %}selected{% endif %}>Structured Simple</option>
                            <option value="accuracy_focused" {% if env_vars.OPENAI_PROMPT_TYPE == 'accuracy_focused' %}selected{% endif %}>Accuracy Focused</option>
                            <option value="examples" {% if env_vars.OPENAI_PROMPT_TYPE == 'examples' %}selected{% endif %}>With Examples</option>
                            <option value="step_by_step" {% if env_vars.OPENAI_PROMPT_TYPE == 'step_by_step' %}selected{% endif %}>Step by Step</option>
                            <option value="optimized" {% if env_vars.OPENAI_PROMPT_TYPE == 'optimized' %}selected{% endif %}>Optimized (Advanced)</option>
                        </select>
                        <small class="form-text text-muted">Select the prompt style for OpenAI image analysis.</small>
                    </div>

                    <div class="form-group">
                        <label for="OPENAI_PROMPT_ROLE">Prompt Role</label>
                        <textarea class="form-control" id="OPENAI_PROMPT_ROLE" name="OPENAI_PROMPT_ROLE" rows="3">{{ env_vars.OPENAI_PROMPT_ROLE }}</textarea>
                        <small class="form-text text-muted">The role instruction for the AI (e.g., "Act as an expert in wooden construction...")</small>
                    </div>

                    <div class="form-group">
                        <label for="OPENAI_PROMPT_INSTRUCTIONS_PRE">Pre-Instructions</label>
                        <textarea class="form-control" id="OPENAI_PROMPT_INSTRUCTIONS_PRE" name="OPENAI_PROMPT_INSTRUCTIONS_PRE" rows="6">{{ env_vars.OPENAI_PROMPT_INSTRUCTIONS_PRE }}</textarea>
                        <small class="form-text text-muted">Instructions that appear before the field descriptions</small>
                    </div>

                    <div class="form-group">
                        <label for="OPENAI_PROMPT_INSTRUCTIONS_POST">Post-Instructions</label>
                        <textarea class="form-control" id="OPENAI_PROMPT_INSTRUCTIONS_POST" name="OPENAI_PROMPT_INSTRUCTIONS_POST" rows="6">{{ env_vars.OPENAI_PROMPT_INSTRUCTIONS_POST }}</textarea>
                        <small class="form-text text-muted">Instructions that appear after the field descriptions</small>
                    </div>

                    <div class="form-group">
                        <label for="OPENAI_PROMPT_EXAMPLE">Example Output</label>
                        <textarea class="form-control" id="OPENAI_PROMPT_EXAMPLE" name="OPENAI_PROMPT_EXAMPLE" rows="6">{{ env_vars.OPENAI_PROMPT_EXAMPLE }}</textarea>
                        <small class="form-text text-muted">Example of the expected output format</small>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Prompt Settings</button>
                </form>

                <script>
                    // Function to load prompt settings based on selected type
                    console.log('Script loaded, looking for OPENAI_PROMPT_TYPE element');
                    const promptTypeSelect = document.getElementById('OPENAI_PROMPT_TYPE');
                    console.log('Found element:', promptTypeSelect);

                    promptTypeSelect.addEventListener('change', function() {
                        const promptType = this.value;

                        // Show loading indicator
                        const loadingMsg = document.createElement('div');
                        loadingMsg.id = 'loading-prompt';
                        loadingMsg.className = 'alert alert-info mt-3';
                        loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading prompt settings...';
                        this.parentNode.appendChild(loadingMsg);

                        // Fetch prompt settings via AJAX
                        console.log('Fetching prompt template for type:', promptType);
                        fetch('/settings/get_prompt_template?type=' + promptType)
                            .then(response => {
                                console.log('Response status:', response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log('Received data:', data);
                                if (data.success) {
                                    // Update form fields with the loaded template
                                    document.getElementById('OPENAI_PROMPT_ROLE').value = data.role || '';
                                    document.getElementById('OPENAI_PROMPT_INSTRUCTIONS_PRE').value = data.instructions_pre || '';
                                    document.getElementById('OPENAI_PROMPT_INSTRUCTIONS_POST').value = data.instructions_post || '';
                                    document.getElementById('OPENAI_PROMPT_EXAMPLE').value = data.example || '';

                                    // Show success message
                                    const successMsg = document.createElement('div');
                                    successMsg.className = 'alert alert-success mt-3';
                                    successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Prompt template loaded. You can now edit and save these settings.';
                                    successMsg.style.opacity = '1';

                                    // Replace loading message with success
                                    const loadingElement = document.getElementById('loading-prompt');
                                    if (loadingElement) {
                                        loadingElement.parentNode.replaceChild(successMsg, loadingElement);

                                        // Fade out success message after 3 seconds
                                        setTimeout(() => {
                                            let opacity = 1;
                                            const fadeInterval = setInterval(() => {
                                                if (opacity <= 0.1) {
                                                    clearInterval(fadeInterval);
                                                    successMsg.remove();
                                                }
                                                successMsg.style.opacity = opacity;
                                                opacity -= 0.1;
                                            }, 100);
                                        }, 3000);
                                    }
                                } else {
                                    // Show error message
                                    const errorMsg = document.createElement('div');
                                    errorMsg.className = 'alert alert-danger mt-3';
                                    errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + (data.error || 'Failed to load prompt template');

                                    // Replace loading message with error
                                    const loadingElement = document.getElementById('loading-prompt');
                                    if (loadingElement) {
                                        loadingElement.parentNode.replaceChild(errorMsg, loadingElement);

                                        // Remove error after 5 seconds
                                        setTimeout(() => errorMsg.remove(), 5000);
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error loading prompt template:', error);

                                // Show error message
                                const errorMsg = document.createElement('div');
                                errorMsg.className = 'alert alert-danger mt-3';
                                errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error loading prompt template: ' + error.message;

                                // Replace loading message with error
                                const loadingElement = document.getElementById('loading-prompt');
                                if (loadingElement) {
                                    loadingElement.parentNode.replaceChild(errorMsg, loadingElement);

                                    // Remove error after 10 seconds
                                    setTimeout(() => errorMsg.remove(), 10000);
                                }
                            });

                    });

                    // Trigger change event on page load to load the current template
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('DOM loaded, triggering change event');
                        const event = new Event('change');
                        promptTypeSelect.dispatchEvent(event);
                    });
                </script>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-sliders-h"></i> Model Parameters</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('settings.update_model_params') }}" method="post">
                            <div class="form-group">
                                <label for="MODEL_NAME">Model</label>
                                <select class="form-control" id="MODEL_NAME" name="MODEL_NAME">
                                    <option value="gpt-4-vision-preview" {% if env_vars.MODEL_NAME == 'gpt-4-vision-preview' %}selected{% endif %}>GPT-4 Vision Preview</option>
                                    <option value="gpt-4o" {% if env_vars.MODEL_NAME == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
                                    <option value="gpt-4-turbo" {% if env_vars.MODEL_NAME == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                                </select>
                                <small class="form-text text-muted">Select the OpenAI model to use for image analysis.</small>
                            </div>

                            <div class="form-group">
                                <label for="MAX_TOKENS">Max Tokens</label>
                                <input type="number" class="form-control" id="MODEL_MAX_TOKENS" name="MAX_TOKENS" value="{{ env_vars.MAX_TOKENS }}">
                                <small class="form-text text-muted">Maximum number of tokens in the response.</small>
                            </div>

                            <div class="form-group">
                                <label for="TEMPERATURE">Temperature</label>
                                <input type="number" step="0.1" min="0" max="2" class="form-control" id="TEMPERATURE" name="TEMPERATURE" value="{{ env_vars.TEMPERATURE|default(0.5) }}">
                                <small class="form-text text-muted">Controls randomness (0-2). Lower values are more deterministic.</small>
                            </div>

                            <div class="form-group">
                                <label for="IMAGE_DETAIL">Image Detail Level</label>
                                <select class="form-control" id="IMAGE_DETAIL" name="IMAGE_DETAIL">
                                    <option value="auto" {% if env_vars.IMAGE_DETAIL == 'auto' %}selected{% endif %}>Auto</option>
                                    <option value="low" {% if env_vars.IMAGE_DETAIL == 'low' %}selected{% endif %}>Low</option>
                                    <option value="high" {% if env_vars.IMAGE_DETAIL == 'high' %}selected{% endif %}>High</option>
                                </select>
                                <small class="form-text text-muted">Detail level for image analysis. Higher detail costs more tokens.</small>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Model Parameters</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-trash-alt"></i> Clean Directories</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Warning: Cleaning directories will permanently delete files. This action cannot be undone.
                </div>

                <div class="list-group">
                    <a href="{{ url_for('settings.clean_directory', directory='downloads') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the downloads directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-download"></i> Clean Downloads Directory</h6>
                        </div>
                        <small>Delete all files in the downloads directory.</small>
                    </a>
                    <a href="{{ url_for('settings.clean_directory', directory='metadata') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the metadata directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-file-alt"></i> Clean Metadata Directory</h6>
                        </div>
                        <small>Delete all files in the metadata directory.</small>
                    </a>
                    <a href="{{ url_for('settings.clean_directory', directory='analysis') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the analysis directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-brain"></i> Clean Analysis Directory</h6>
                        </div>
                        <small>Delete all files in the analysis directory.</small>
                    </a>
                    <a href="{{ url_for('settings.clean_directory', directory='upload') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the upload directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-upload"></i> Clean Upload Directory</h6>
                        </div>
                        <small>Delete all files in the upload directory.</small>
                    </a>
                    <a href="{{ url_for('settings.clean_directory', directory='upload_metadata') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the upload metadata directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-tags"></i> Clean Upload Metadata Directory</h6>
                        </div>
                        <small>Delete all files in the upload metadata directory.</small>
                    </a>
                    <a href="{{ url_for('settings.clean_directory', directory='uploaded') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the uploaded directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-cloud-upload-alt"></i> Clean Uploaded Directory</h6>
                        </div>
                        <small>Delete all files in the uploaded directory.</small>
                    </a>
                    <a href="{{ url_for('settings.clean_directory', directory='processed') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the processed directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-cogs"></i> Clean Processed Directory</h6>
                        </div>
                        <small>Delete all files in the processed directory.</small>
                    </a>
                    <a href="{{ url_for('settings.clean_directory', directory='reports') }}" class="list-group-item list-group-item-action" onclick="return confirm('Are you sure you want to clean the reports directory?');">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="fas fa-file-alt"></i> Clean Reports Directory</h6>
                        </div>
                        <small>Delete all files in the reports directory.</small>
                    </a>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> System Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <th>Version</th>
                            <td>1.0.0</td>
                        </tr>
                        <tr>
                            <th>Data Directory</th>
                            <td>{{ config.data_dir }}</td>
                        </tr>
                        <tr>
                            <th>Logs Directory</th>
                            <td>{{ config.logs_dir }}</td>
                        </tr>
                        <tr>
                            <th>Config Directory</th>
                            <td>{{ config.config_dir }}</td>
                        </tr>
                    </tbody>
                </table>

                {% if schema %}
                <h6 class="mt-4">SharePoint Schema</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th>Type</th>
                                <th>Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for field in schema.fields %}
                            <tr>
                                <td>{{ field.title }}</td>
                                <td>{{ field.type }}</td>
                                <td>{% if field.required %}Yes{% else %}No{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle"></i> SharePoint schema not loaded. Run "Load Metadata Schema" from the dashboard.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
