# Подробное описание рабочего процесса (workflow) проекта

## Общий обзор

Данный проект представляет собой автоматизированную систему для обработки фотографий строительных проектов компании ERNI, специализирующейся на деревянных конструкциях. Система выполняет полный цикл обработки: от загрузки фотографий из SharePoint, их анализа с помощью искусственного интеллекта, до генерации метаданных и загрузки обратно в SharePoint с обогащенной информацией.

## Детальный рабочий процесс

### 1. Инициализация и настройка

**Компоненты:**
- Docker-контейнер с Python-окружением
- Конфигурационные файлы (config.env, sharepoint_choices.json)
- Директории для хранения данных

**Процесс:**
1. Система загружается и инициализирует необходимые директории:
   - `/app/data/downloads` - для загрузки файлов из SharePoint
   - `/app/data/metadata` - для хранения EXIF-метаданных
   - `/app/data/analysis` - для результатов анализа OpenAI
   - `/app/data/upload` - для подготовки файлов к загрузке
   - `/app/data/uploaded` - для успешно загруженных файлов
   - `/app/data/processed` - для обработанных файлов
   - `/app/data/registry` - для реестра файлов

2. Система загружает конфигурацию:
   - Учетные данные SharePoint
   - Настройки OpenAI API
   - Промпты для анализа фотографий
   - Схему метаданных SharePoint

### 2. Загрузка схемы метаданных из SharePoint

**Модуль:** `metadata_schema.py`

**Процесс:**
1. Система подключается к SharePoint с использованием учетных данных
2. Извлекает схему метаданных из библиотеки "Referenzfotos"
3. Преобразует схему в удобный для использования формат
4. Сохраняет схему в файл `sharepoint_choices.json`

**Результат:**
- Файл с полной схемой метаданных, включая:
  - Названия полей
  - Типы полей (текст, выбор, множественный выбор)
  - Допустимые значения для полей с выбором
  - Обязательные поля

### 3. Загрузка фотографий из SharePoint

**Модуль:** `photo_metadata.py`

**Процесс:**
1. Система подключается к SharePoint
2. Получает список фотографий из библиотеки "Referenzfotos"
3. Загружает фотографии пакетами по 10 штук
4. Для каждой фотографии:
   - Проверяет размер файла (пропускает файлы > 15 МБ)
   - Загружает файл в директорию `/app/data/downloads`
   - Извлекает EXIF-метаданные с помощью библиотеки PIL
   - Форматирует EXIF-данные в читаемый вид, включая GPS-координаты
   - Сохраняет метаданные в YAML-файл в директории `/app/data/metadata`
   - Добавляет запись в реестр загруженных файлов
   - Перемещает файл в директорию `/app/data/processed` на стороне SharePoint

**Результат:**
- Загруженные фотографии в директории `/app/data/downloads`
- YAML-файлы с EXIF-метаданными в директории `/app/data/metadata`
- Обновленный реестр загруженных файлов

### 4. Анализ фотографий с помощью OpenAI

**Модуль:** `openai_analyzer.py`

**Процесс:**
1. Система находит фотографии в директории `/app/data/downloads`
2. Загружает схему метаданных из файла `sharepoint_choices.json`
3. Для каждой фотографии:
   - Проверяет, была ли она уже проанализирована (по хешу файла)
   - Извлекает и форматирует EXIF-метаданные
   - Подготавливает промпт для OpenAI, включая EXIF-данные
   - Оптимизирует изображение (уменьшает до максимального размера 1024 пикселя)
   - Кодирует изображение в base64
   - Отправляет запрос к OpenAI API (модель GPT-4o)
   - Получает и парсит JSON-ответ
   - Сохраняет результаты анализа в JSON-файл в директории `/app/data/analysis`
   - Добавляет запись в реестр проанализированных файлов

**Особенности:**
- Параллельная обработка с использованием ThreadPoolExecutor
- Ограничение количества одновременных запросов (OPENAI_CONCURRENCY_LIMIT = 10)
- Механизм повторных попыток при ошибках
- Кэширование результатов анализа

**Результат:**
- JSON-файлы с результатами анализа в директории `/app/data/analysis`
- Обновленный реестр проанализированных файлов

### 5. Генерация метаданных для загрузки в SharePoint

**Модуль:** `metadata_generator.py`

**Процесс:**
1. Система находит фотографии, которые были проанализированы, но еще не загружены
2. Загружает схему метаданных из файла `sharepoint_choices.json`
3. Для каждой фотографии:
   - Генерирует новое имя файла по маске `Erni_Referenzfoto_{number}`
   - Загружает результаты анализа OpenAI и EXIF-метаданные
   - Интеллектуально объединяет данные из обоих источников с учетом приоритетов
   - Для GPS-координат пытается выполнить геокодирование для определения местоположения
   - Валидирует значения полей в соответствии со схемой SharePoint
   - Преобразует поля с множественным выбором в формат, понятный SharePoint
   - Сохраняет метаданные в JSON-файл в директории `/app/data/upload/metadata`
   - Копирует YAML-файл с EXIF-метаданными в ту же директорию
   - Копирует фотографию в директорию `/app/data/upload` с новым именем

**Особенности:**
- Интеллектуальное объединение данных из разных источников
- Приоритеты источников для разных полей (например, дата из EXIF, описание из OpenAI)
- Геокодирование GPS-координат с использованием API Nominatim
- Валидация метаданных в соответствии со схемой SharePoint

**Результат:**
- Фотографии с новыми именами в директории `/app/data/upload`
- JSON-файлы с метаданными в директории `/app/data/upload/metadata`
- YAML-файлы с EXIF-метаданными в директории `/app/data/upload/metadata`

### 6. Загрузка фотографий в SharePoint

**Модуль:** `sharepoint_uploader.py`

**Процесс:**
1. Система находит фотографии в директории `/app/data/upload`
2. Подключается к SharePoint
3. Для каждой фотографии:
   - Загружает файл в библиотеку "Referenzfotos"
   - Загружает соответствующий JSON-файл с метаданными
   - Обновляет метаданные файла в SharePoint
   - Загружает YAML-файл с EXIF-метаданными
   - Добавляет запись в реестр загруженных файлов
   - Перемещает файлы из директории `/app/data/upload` в `/app/data/uploaded`

**Особенности:**
- Пакетная загрузка файлов (по 10 штук)
- Механизм повторных попыток при ошибках
- Обновление реестра загруженных файлов

**Результат:**
- Фотографии, загруженные в SharePoint с обогащенными метаданными
- Файлы, перемещенные в директорию `/app/data/uploaded`
- Обновленный реестр загруженных файлов

### 7. Автоматический процесс

**Модуль:** `auto_process.py`

**Процесс:**
1. Система последовательно запускает все модули:
   - `metadata_schema.py` - загрузка схемы метаданных
   - `photo_metadata.py` - загрузка фотографий и извлечение EXIF
   - `openai_analyzer.py` - анализ фотографий с OpenAI
   - `metadata_generator.py` - генерация метаданных
   - `sharepoint_uploader.py` - загрузка фотографий в SharePoint

**Особенности:**
- Полностью автоматический процесс
- Обработка ошибок на каждом этапе
- Логирование всех действий

**Результат:**
- Полный цикл обработки фотографий от загрузки до загрузки обратно с обогащенными метаданными

## Ключевые технические аспекты

### 1. Обработка EXIF-метаданных

- Извлечение метаданных с помощью библиотеки PIL
- Форматирование GPS-координат в читаемый вид
- Сохранение метаданных в YAML-формате
- Использование метаданных для обогащения промпта OpenAI

### 2. Интеграция с OpenAI

- Использование модели GPT-4o для анализа изображений
- Формирование промпта с включением EXIF-данных
- Оптимизация изображений перед отправкой
- Парсинг и валидация JSON-ответа

### 3. Интеллектуальное объединение данных

- Определение приоритетов источников для разных полей
- Маппинг EXIF-тегов на поля SharePoint
- Валидация значений в соответствии со схемой
- Геокодирование GPS-координат

### 4. Интеграция с SharePoint

- Аутентификация с использованием учетных данных
- Загрузка и выгрузка файлов
- Обновление метаданных файлов
- Работа с библиотеками и списками

### 5. Оптимизация производительности

- Пакетная обработка файлов
- Параллельная обработка с использованием ThreadPoolExecutor
- Кэширование результатов
- Механизмы повторных попыток

### 6. Отказоустойчивость

- Обработка ошибок на каждом этапе
- Логирование всех действий
- Сохранение промежуточных результатов
- Реестр обработанных файлов для предотвращения повторной обработки

## Схема потока данных

```
SharePoint (Referenzfotos) --> Загрузка фотографий --> Извлечение EXIF --> Анализ OpenAI --> Генерация метаданных --> Загрузка в SharePoint
    |                                                       |                   |                      |
    |                                                       v                   v                      |
    |                                                EXIF-метаданные --> Интеллектуальное объединение |
    |                                                                           |                      |
    v                                                                           v                      v
Схема метаданных ------------------------------------------------> Валидация метаданных --> Обновление метаданных
```

## Заключение

Данный проект представляет собой комплексное решение для автоматизации обработки фотографий строительных проектов. Система интегрирует различные технологии (SharePoint, OpenAI, геокодирование) для создания полного цикла обработки фотографий с минимальным участием человека.

Ключевыми особенностями являются интеллектуальное объединение данных из разных источников, использование искусственного интеллекта для анализа изображений и автоматическое обогащение метаданных с учетом контекста фотографий.

Система спроектирована с учетом масштабируемости, отказоустойчивости и производительности, что позволяет обрабатывать большие объемы фотографий эффективно и надежно.
